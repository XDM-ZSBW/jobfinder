name: CI/CD Pipeline

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:

env:
  NODE_VERSION: '20'
  PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  SERVICE_NAME: jobmatch-backend
  REGION: us-central1

jobs:
  # Lint and Type Check
  lint-and-typecheck:
    name: Lint & Type Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install root dependencies
        run: npm ci

      - name: Install frontend dependencies
        working-directory: ./frontend
        run: npm ci

      - name: Install backend dependencies
        working-directory: ./backend
        run: npm ci

      - name: Lint frontend
        working-directory: ./frontend
        run: npm run lint || echo "Linting issues found but continuing..."

      - name: Lint backend
        working-directory: ./backend
        run: npm run lint || echo "Linting issues found but continuing..."

      - name: Type check frontend
        working-directory: ./frontend
        run: npm run typecheck

      - name: Type check backend
        working-directory: ./backend
        run: npm run typecheck

  # Build Tests
  build:
    name: Build
    runs-on: ubuntu-latest
    needs: lint-and-typecheck
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install root dependencies
        run: npm ci

      - name: Build frontend
        working-directory: ./frontend
        run: |
          npm ci
          npm run build

      - name: Build backend
        working-directory: ./backend
        run: |
          npm ci
          npm run build

      - name: Verify build artifacts
        run: |
          if [ ! -d "frontend/dist" ]; then
            echo "‚ùå Frontend build failed - dist directory not found"
            exit 1
          fi
          if [ ! -d "backend/dist" ]; then
            echo "‚ùå Backend build failed - dist directory not found"
            exit 1
          fi
          echo "‚úÖ Build artifacts verified"

  # Run Tests (if available)
  test:
    name: Test
    runs-on: ubuntu-latest
    needs: lint-and-typecheck
    continue-on-error: true
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install root dependencies
        run: npm ci

      - name: Run tests
        run: npm run test || echo "Tests failed but continuing..."

  # Deploy Backend to Cloud Run
  # DISABLED: Using Vercel-only deployment via deploy-vercel-ci-cd.yml
  deploy-backend:
    name: Deploy Backend (DISABLED - Vercel Only)
    runs-on: ubuntu-latest
    needs: [lint-and-typecheck, build]
    if: false  # Disabled - always false
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure Docker for GCR
        run: gcloud auth configure-docker --quiet

      - name: Build backend
        working-directory: ./backend
        run: |
          npm ci
          npm run build

      - name: Build and Push Container Image
        run: |
          docker build -t gcr.io/$PROJECT_ID/$SERVICE_NAME:$GITHUB_SHA \
            -f Dockerfile.cloudrun \
            --build-arg BUILDKIT_INLINE_CACHE=1 .
          docker tag gcr.io/$PROJECT_ID/$SERVICE_NAME:$GITHUB_SHA \
            gcr.io/$PROJECT_ID/$SERVICE_NAME:latest
          docker push gcr.io/$PROJECT_ID/$SERVICE_NAME:$GITHUB_SHA
          docker push gcr.io/$PROJECT_ID/$SERVICE_NAME:latest

      - name: Deploy to Cloud Run
        env:
          TWILIO_WEBSOCKET_URL: ${{ secrets.TWILIO_WEBSOCKET_URL || 'wss://jobmatch.zip/api/voice/websocket' }}
        run: |
          echo "Deploying to Cloud Run with WebSocket support..."
          gcloud run deploy $SERVICE_NAME \
            --image gcr.io/$PROJECT_ID/$SERVICE_NAME:$GITHUB_SHA \
            --platform managed \
            --region $REGION \
            --port 8080 \
            --memory 1Gi \
            --cpu 2 \
            --min-instances 1 \
            --max-instances 10 \
            --timeout 300 \
            --allow-unauthenticated \
            --set-env-vars "TWILIO_WEBSOCKET_URL=$TWILIO_WEBSOCKET_URL" \
            --quiet

      - name: Get Service URL
        id: service-url
        run: |
          URL=$(gcloud run services describe $SERVICE_NAME \
            --region $REGION \
            --format="value(status.url)")
          echo "url=$URL" >> $GITHUB_OUTPUT

      - name: Output Service URL
        run: |
          echo "‚úÖ Backend deployment successful!"
          echo "üåê Service URL: ${{ steps.service-url.outputs.url }}"
          echo "üîå WebSocket URL: wss://jobmatch.zip/api/voice/websocket"
          echo "üìû Twilio ConversationRelay configured with ElevenLabs voice"

  # Deploy Frontend to VM (jobmatch.zip)
  deploy-frontend:
    name: Deploy Frontend to jobmatch.zip
    runs-on: ubuntu-latest
    needs: [lint-and-typecheck, build]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Build frontend
        working-directory: ./frontend
        run: |
          npm ci
          npm run build

      - name: Create deployment package
        run: |
          zip -r deploy.zip \
            frontend/dist \
            frontend/public \
            frontend/package.json \
            backend/dist \
            backend/package.json \
            docker-compose.yml \
            Dockerfile \
            public/ \
            -x "*.git*" "node_modules/*" "*.test.*" "*.spec.*"

      - name: Deploy to VM
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.VM_HOST }}
          username: ${{ secrets.VM_USER }}
          key: ${{ secrets.VM_SSH_KEY }}
          port: 22
          source: "deploy.zip"
          target: "/opt/jobmatch/"

      - name: Run deployment script
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VM_HOST }}
          username: ${{ secrets.VM_USER }}
          key: ${{ secrets.VM_SSH_KEY }}
          port: 22
          script: |
            set -e
            cd /opt/jobmatch
            
            echo "üì¶ Extracting deployment package..."
            unzip -o deploy.zip || true
            rm -f deploy.zip
            
            echo "üîß Ensuring .env file exists..."
            if [ ! -f .env ]; then
              VM_IP=$(curl -s http://metadata.google.internal/computeMetadata/v1/instance/network-interfaces/0/access-configs/0/external-ip -H 'Metadata-Flavor: Google' || echo "localhost")
              cat > .env <<ENVEOF
            DATABASE_URL=postgresql://jobfinder:jobfinder@postgres:5432/jobfinder
            REDIS_URL=redis://redis:6379
            ELASTICSEARCH_URL=http://elasticsearch:9200
            SECRET_KEY=$(openssl rand -hex 32)
            ENVIRONMENT=production
            CORS_ORIGINS=https://jobmatch.zip,https://www.jobmatch.zip,http://localhost:3000
            NEXT_PUBLIC_API_URL=https://api.jobmatch.zip
            ENVEOF
            fi
            
            echo "üê≥ Restarting Docker services..."
            sudo docker compose down || true
            sudo docker compose up -d --build
            
            echo "‚è≥ Waiting for services to start..."
            sleep 30
            
            echo "üè• Checking service health..."
            for i in {1..6}; do
              if curl -f http://localhost:4000/health > /dev/null 2>&1; then
                echo "‚úÖ Backend is healthy!"
                exit 0
              fi
              echo "‚è≥ Attempt $i/6 - waiting 10 seconds..."
              sleep 10
            done
            
            echo "‚ö†Ô∏è Health check failed, but deployment completed"
            sudo docker compose ps
            sudo docker compose logs --tail=50

      - name: Verify deployment
        run: |
          echo "‚úÖ Frontend deployment to jobmatch.zip completed!"
          echo "üåê Site should be available at https://jobmatch.zip"

